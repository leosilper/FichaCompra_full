<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Novo Pedido - FichaCompra</title>
  <link rel="stylesheet" href="/css/styles.css">
  <script>
    async function onCustomerChange(sel) {
      if(!sel.value) return;
      const res = await fetch('/customers/' + sel.value);
      const c = await res.json();
      if (c && c.defaultDestination) document.getElementById('destination').value = c.defaultDestination;
      if (c && c.defaultSatellite)   document.getElementById('satellite').value   = c.defaultSatellite;
      if (c && c.defaultConvenience) document.getElementById('convenience').value = c.defaultConvenience;
    }
    async function onCollectionChange(sel, idx) {
      const code = sel.value;
      if (!code) return;
      const res = await fetch('/subcollections?parentCode=' + encodeURIComponent(code));
      const list = await res.json();
      const sub = document.getElementById('items['+idx+'].subcollection');
      sub.innerHTML = '<option value="">Selecione...</option>';
      list.forEach(it => {
        const o = document.createElement('option');
        o.value = it.code; o.text = it.label;
        sub.appendChild(o);
      });
    }
    function addItemRow() {
      const idx = document.querySelectorAll('.item-row').length;
      const tpl = document.getElementById('item-template').innerHTML.replace(/__IDX__/g, idx);
      document.getElementById('items').insertAdjacentHTML('beforeend', tpl);
    }
  </script>
</head>
<body>
  <h1>Novo Pedido</h1>

  <form method="post" th:object="${pr}">
    <div class="row">
      <label>Número:</label>
      <input type="text" th:field="*{requestNumber}" readonly>
    </div>

    <div class="row">
      <label>Cliente:</label>
      <select th:field="*{customer}" onchange="onCustomerChange(this)">
        <option value="">Selecione...</option>
        <option th:each="c: ${customers}" th:value="${c.id}" th:text="${c.name}"></option>
      </select>
    </div>

    <div class="row">
      <label>Destino</label>
      <select id="destination" th:field="*{destination}">
        <option value="">Selecione...</option>
        <option th:each="d: ${destinos}" th:value="${d.code}" th:text="${d.label}"></option>
      </select>

      <label>Satélite</label>
      <select id="satellite" th:field="*{satellite}">
        <option value="">Selecione...</option>
        <option th:each="s: ${satelites}" th:value="${s.code}" th:text="${s.label}"></option>
      </select>

      <label>Conveniência</label>
      <select id="convenience" th:field="*{convenience}">
        <option value="">Selecione...</option>
        <option th:each="c: ${conveniencias}" th:value="${c.code}" th:text="${c.label}"></option>
      </select>
    </div>

    <h3>Itens</h3>
    <div id="items"></div>
    <button class="btn" type="button" onclick="addItemRow()">+ Adicionar item</button>

    <div class="actions">
      <button class="btn primary" type="submit">Salvar</button>
      <a class="btn" href="/">Cancelar</a>
    </div>
  </form>

  <!-- Template de linha -->
  <script type="text/template" id="item-template">
    <div class="item-row">
      <fieldset>
        <legend>Item __IDX__</legend>

        <label>Marca</label><input name="items[__IDX__].brand" required>
        <label>Modelo</label><input name="items[__IDX__].modelName" required>
        <label>Cor</label><input name="items[__IDX__].color" required>

        <label>Gênero</label>
        <select name="items[__IDX__].gender" required>
          <option value="">Selecione...</option>
          <option th:each="g: ${generos}" th:value="${g.code}" th:text="${g.label}"></option>
        </select>

        <label>Ciclo de vida</label>
        <select name="items[__IDX__].lifecycle" required>
          <option value="">Selecione...</option>
          <option th:each="c: ${ciclos}" th:value="${c.code}" th:text="${c.label}"></option>
        </select>

        <label>Coleção</label>
        <select name="items[__IDX__].collection" required onchange="onCollectionChange(this, __IDX__)">
          <option value="">Selecione...</option>
          <option th:each="c: ${colecoes}" th:value="${c.code}" th:text="${c.label}"></option>
        </select>

        <label>Subcoleção</label>
        <select id="items[__IDX__].subcollection" name="items[__IDX__].subcollection">
          <option value="">Selecione...</option>
        </select>

        <label>SKU Fornecedor</label><input name="items[__IDX__].skuVendor">
        <label>EAN</label><input name="items[__IDX__].ean">
        <label>Grade</label><input name="items[__IDX__].sizeScale">
        <label>Custo</label><input type="number" step="0.01" name="items[__IDX__].priceCost">
        <label>Preço</label><input type="number" step="0.01" name="items[__IDX__].priceList">

        <input type="hidden" name="items[__IDX__].standardDescription" value="">
      </fieldset>
    </div>
  </script>
</body>
</html>
